from calibre.web.feeds.news import BasicNewsRecipe
from calibre.utils.threadpool import ThreadPool, makeRequests
import time
from datetime import datetime
from lxml import html
from urllib2 import urlopen

class Economist(BasicNewsRecipe):

    title = 'The Economist (free)'
    language = 'en'

    __author__ = "Kovid Goyal"
    description = ('Global news and current affairs from a European perspective.'
            ' Much slower than the subscription based version.')

    oldest_article = 6.5
    cover_url = 'http://www.economist.com/images/covers/currentcovereu_large.jpg'
    remove_tags = [dict(name=['script', 'noscript', 'title'])]
    remove_tags_before = dict(name=lambda tag: tag.name=='title' and tag.parent.name=='body')

    def parse_index(self):
        from calibre.web.feeds.feedparser import parse
        raw = self.index_to_soup(
                'http://feeds.feedburner.com/economist/full_print_edition',
                raw=True)
        entries = parse(raw).entries
        pool = ThreadPool(10)
        self.feed_dict = {}
        requests = []
        for i, item in enumerate(entries):
            published   = time.gmtime(item.get('timestamp', time.time()))
            title       = item.get('title', _('Untitled article'))
            link        = item.get('link', None)
            description = item.get('description', '')
            author      = item.get('author', '')

            requests.append([i, link, title, description, author, published])
        requests = makeRequests(self.process_eco_feed_article, requests, self.eco_article_found,
                self.eco_article_failed)
        for r in requests: pool.putRequest(r)
        pool.wait()

        return [(t, a) for t, a in self.feed_dict.items()]

    def process_eco_feed_article(self, args):
        i, url, title, description, author, published = args
        ret = urlopen(url)
        raw = ret.read()
        url = ret.geturl().replace('displaystory', 'PrinterFriendly').strip()
        root = html.fromstring(raw)
        matches = root.xpath('//*[@class = "article-section"]')
        feedtitle = 'Miscellaneous'
        if matches:
            feedtitle = html.tostring(matches[0], method='text',
                    encoding=unicode)
        return (i, feedtitle, url, title, description, author, published)

    def eco_article_found(self, req, result):
        from calibre.web.feeds import Article
        i, feedtitle, link, title, description, author, published = result
        self.log('Found print version for article:', title)

        a = Article(i, title, link, author, description, published, '')
        delta = datetime.utcnow() - a.utctime
        if delta.days*24*3600 + delta.seconds > 24*3600*self.oldest_article:
            self.log.debug('Skipping article %s (%s) from feed %s as it is too old.'%(title, a.localtime.strftime('%a, %d %b, %Y %H:%M'), title))
            return


        article = dict(title=a.title, description=a.text_summary,
            date=time.strftime(self.timefmt, a.date), author=a.author, url=a.url)
        if feedtitle not in self.feed_dict:
            self.feed_dict[feedtitle] = []
        self.feed_dict[feedtitle].append(article)

    def eco_article_failed(self, req, tb):
        self.log.error('Failed to download %s with error:'%req.args[0][2])
        self.log.debug(tb)
