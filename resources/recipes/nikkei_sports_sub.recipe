import string, re, sys
from calibre import strftime
from calibre.web.feeds.recipes import BasicNewsRecipe

class NikkeiNet_subscription(BasicNewsRecipe):
    title          = u'\u65e5\u7d4c\u65b0\u805e\u96fb\u5b50\u7248'
    __author__     = 'Hiroshi Miura'
    description    = 'News and current market affairs from Japan'
    needs_subscription = True
    oldest_article = 3
    max_articles_per_feed = 20
    language       = 'ja'
 
    feeds          =  [ 
		 (u'\u30b9\u30dd\u30fc\u30c4\uff1a\u30d7\u30ed\u91ce\u7403', u'http://www.zou3.net/php/rss/nikkei2rss.php?head=baseball'),
		 (u'\u30b9\u30dd\u30fc\u30c4\uff1a\u5927\u30ea\u30fc\u30b0', u'http://www.zou3.net/php/rss/nikkei2rss.php?head=mlb'),
		 (u'\u30b9\u30dd\u30fc\u30c4\uff1a\u30b5\u30c3\u30ab\u30fc', u'http://www.zou3.net/php/rss/nikkei2rss.php?head=soccer'), 
		 (u'\u30b9\u30dd\u30fc\u30c4\uff1a\u30b4\u30eb\u30d5', 	u'http://www.zou3.net/php/rss/nikkei2rss.php?head=golf'),
		 (u'\u30b9\u30dd\u30fc\u30c4\uff1a\u76f8\u64b2', 	u'http://www.zou3.net/php/rss/nikkei2rss.php?head=sumou'),
		 (u'\u30b9\u30dd\u30fc\u30c4\uff1a\u7af6\u99ac', 	u'http://www.zou3.net/php/rss/nikkei2rss.php?head=keiba')
		]

    remove_tags_before = dict(id="CONTENTS")
    remove_tags = [
                   dict(name="form"),
                   {'class':"cmn-hide"},
                  ]
    remove_tags_after = {'class':"cmn-pr_list"}
    recursions  = 4

    def get_browser(self):
        br = BasicNewsRecipe.get_browser()
        if self.username is not None and self.password is not None:
            br.open('https://id.nikkei.com/lounge/nl/base/LA0010.seam?cid=123456&flashId=654321')
            assert br.viewing_html()
            print br.title()
            response = br.response()
            response.set_data(response.get_data().replace("<input id=\"j_id48\"", "<!-- "))
            response.set_data(response.get_data().replace("gm_home_on.gif\" />", " -->"))
            br.set_response(response)
            br.select_form(name='LA0010Form01')
            br['LA0010Form01:LA0010Email']   = self.username
            br['LA0010Form01:LA0010Password'] = self.password
            res = br.submit()
            raw = res.read()
            if '&#26085;&#32076;ID&#12398;&#12469;&#12540;&#12499;&#12473;&#19968;&#35239;&#12408;' not in raw:
                raise ValueError('Failed to log in to nikkei.net, check your username(email address) and password')
        return br
